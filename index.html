<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MdxAcademy</title>
    <link rel="stylesheet" href="style/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
  </head>

  <body>
    <div id="app" class="body-wrapper">
      <!-- Toast -->
      <div v-if="toastVisible" class="toast">{{ toastMessage }}</div>
      <div class="product-section" v-if="isProductPage">
        <nav>
          <a href="#" class="navbar-brand">MdxAcademy</a>

          <div class="searchbar-wrapper">
            <div class="searchbar">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input
                type="text"
                placeholder="Search lesson..."
                v-model="searchQuery"
                @input="searchLessons"
              />
            </div>
          </div>

          <div class="cart-button">
            <button :disabled="checkOrders" @click="toggleCheckOutPage">
              <i class="fa-solid fa-cart-shopping"></i>
            </button>

            <!-- ADMIN MODE BUTTON -->
            <button class="visibility-mode" @click="toggleAdminMode">
              <i class="fa-solid fa-user-shield"></i>
            </button>

            <button class="visibility-mode" @click="toggleDarkMode">
              <i v-if="isDarkMode" class="fa-regular fa-sun"></i>
              <i v-else class="fa-solid fa-moon"></i>
            </button>
          </div>
        </nav>

        <div class="main-content">
          <!-- FILTER SECTION -->
          <div class="filter">
            <div class="filter-header">
              <div class="filter-icon">
                <i class="fa-solid fa-filter"></i>
              </div>
              <div class="filter-text"><span>Filter</span></div>
            </div>

            <div class="filter-info">
              <i class="fa-solid fa-circle-info"></i>
              Select your preferences to filter the products.
            </div>

            <div class="filter-categories">
              <div><strong>Sort by:</strong></div>
              <div class="sort-by-options">
                <label>
                  <input
                    type="checkbox"
                    :checked="activeSortIndex === 0"
                    @change="setSort(0)"
                    :disabled="activeSortIndex !== null && activeSortIndex !== 0"
                  />
                  Subject
                </label>

                <label>
                  <input
                    type="checkbox"
                    :checked="activeSortIndex === 1"
                    @change="setSort(1)"
                    :disabled="activeSortIndex !== null && activeSortIndex !== 1"
                  />
                  Location
                </label>

                <label>
                  <input
                    type="checkbox"
                    :checked="activeSortIndex === 2"
                    @change="setSort(2)"
                    :disabled="activeSortIndex !== null && activeSortIndex !== 2"
                  />
                  Price
                </label>

                <label>
                  <input
                    type="checkbox"
                    :checked="activeSortIndex === 3"
                    @change="setSort(3)"
                    :disabled="activeSortIndex !== null && activeSortIndex !== 3"
                  />
                  Availability
                </label>
              </div>
            </div>

            <div class="sorting-order">
              <div><strong>Order:</strong></div>
              <div class="sort-by-options">
                <label>
                  <input
                    type="checkbox"
                    :checked="activeOrder === 'Ascending'"
                    :disabled="activeOrder === 'Descending'"
                    @change="setOrder('Ascending')"
                  />
                  Ascending
                </label>

                <label>
                  <input
                    type="checkbox"
                    :checked="activeOrder === 'Descending'"
                    :disabled="activeOrder === 'Ascending'"
                    @change="setOrder('Descending')"
                  />
                  Descending
                </label>
              </div>
            </div>

            <div class="pedagogy-quote">
              <i class="fa-solid fa-quote-left quote-icon"></i>
              <p class="quote-text">
                "Education is the most powerful weapon which you can use to
                change the world."
              </p>
              <p class="quote-author">— Nelson Mandela</p>
            </div>
          </div>

          <!-- PRODUCT SECTION -->
          <div class="product">
            <div class="product-header">
              <h2>Product List</h2>
              <div class="pagination">
                <button
                  v-for="page in pageList"
                  @click="currentPageNumber = page"
                  :class="{ active: currentPageNumber == page }"
                >
                  {{ page }}
                </button>
              </div>
            </div>

            <div class="lesson-cards">
              <div
                v-for="product in loadCurrentProducts"
                :key="product._id"
                class="lesson-details"
              >
                <!-- ADMIN MODE -->
                <div
                  v-if="isAdminMode"
                  class="admin-edit-icon"
                  @click="startEditing(product)"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </div>

                <div class="image-content">
                  <img :src="product.src" :alt="product.subject" />
                </div>

                <!-- SUBJECT -->
                <div>
                  <strong>Subject:</strong>
                  <span v-if="editingProductId !== product._id">
                    {{ product.subject }}
                  </span>
                  <input
                    v-else
                    class="admin-input"
                    v-model="editableProduct.subject"
                    @keyup.enter="saveEdit(product._id)"
                  />
                </div>

                <!-- LOCATION -->
                <div>
                  <strong>Location:</strong>
                  <span v-if="editingProductId !== product._id">
                    {{ product.location }}
                  </span>
                  <input
                    v-else
                    class="admin-input"
                    v-model="editableProduct.location"
                    @keyup.enter="saveEdit(product._id)"
                  />
                </div>

                <!-- PRICE -->
                <div>
                  <strong>Price:</strong> Rs
                  <span v-if="editingProductId !== product._id">
                    {{ product.price }}
                  </span>
                  <input
                    v-else
                    type="number"
                    class="admin-input"
                    v-model="editableProduct.price"
                    @keyup.enter="saveEdit(product._id)"
                  />
                </div>

                <!-- SPACES -->
                <div>
                  <strong>Spaces:</strong>
                  <span v-if="editingProductId !== product._id">
                    {{ product.spaces }}
                  </span>
                  <input
                    v-else
                    type="number"
                    class="admin-input"
                    v-model="editableProduct.spaces"
                    @keyup.enter="saveEdit(product._id)"
                  />
                </div>

                <!-- ADD TO CART BUTTON -->
                <div class="cart-btn" v-if="!isAdminMode">
                  <button
                    :disabled="product.spaces > 0 ? null : true"
                    @click="addToCart(product)"
                  >
                    <i class="fa-solid fa-cart-plus"></i> Add to cart
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CHECKOUT SECTION -->
      <div class="checkout-container" v-else>
        <button class="back-button" @click="toggleCheckOutPage">
          <i class="fa-solid fa-arrow-left"></i>
          Continue Shopping
        </button>

        <div class="checkout-section">
          <div class="forms-section">
            <!-- Personal Information Form -->
            <div class="information-form">
              <h3>Personal Information</h3>
              <form id="personalForm">
                <div class="form-group">
                  <label for="fullName">Full Name</label>
                  <input id="fullName" v-model="personal.fullName" required />
                </div>

                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input id="email" v-model="personal.email" required />
                </div>

                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input id="phone" v-model="personal.phone" required />
                </div>
              </form>
            </div>

            <!-- Delivery Information Form -->
            <div class="information-form">
              <h3>Delivery Information</h3>
              <form id="deliveryForm">
                <div class="form-group">
                  <label for="address">Street Address</label>
                  <input id="address" v-model="delivery.address" required />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="city">City</label>
                    <input id="city" v-model="delivery.city" required />
                  </div>
                  <div class="form-group">
                    <label for="postalCode">Postal Code</label>
                    <input
                      id="postalCode"
                      v-model="delivery.postalCode"
                      required
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="country">Country</label>
                  <input id="country" v-model="delivery.country" required />
                </div>
              </form>
            </div>
          </div>

          <!-- SHOPPING CART -->
          <div class="shopping-cart">
            <div class="shopping-cart-header">
              <h2>Shopping Cart</h2>
            </div>

            <div class="cart-table-header">
              <div>Product Details</div>
              <div>Subject</div>
              <div>Location</div>
              <div>Price</div>
              <div></div>
            </div>

            <div class="checkout-summary">
              <div class="cart-items">
                <div class="cart-item" v-for="order in orders">
                  <div class="item-product">
                    <img
                      :src="order.src"
                      :alt="order.subject"
                      onerror="this.src='https://via.placeholder.com/70/2d9da8/ffffff?text=Eng'"
                    />
                  </div>
                  <div class="item-subject">{{order.subject}}</div>
                  <div class="item-location">{{order.location}}</div>
                  <div class="item-price">Rs {{order.price}}</div>
                  <button class="remove-btn" @click="removeFromCart(order._id)">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>

              <div class="order-summary">
                <h3>Checkout</h3>
                <div class="summary-details"></div>

                <button class="checkout-btn" @click.prevent="checkout">
                  <i class="fa-solid fa-lock"></i> Checkout
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      var app = new Vue({
        el: "#app",
        data: {
          isProductPage: true,
          isDarkMode: false,
          isAdminMode: false,
          editingProductId: null,
          editableProduct: {},

          products: [],
          orders: [],
          pageNumbers: 0,
          pages: [],
          currentPageNumber: 1,
          currentProducts: [],

          toastVisible: false,
          toastMessage: "",

          activeSortIndex: null,
          activeOrder: null,

          personal: {
            fullName: "",
            email: "",
            phone: "",
          },
          delivery: {
            address: "",
            city: "",
            postalCode: "",
            country: "",
          },

          searchQuery: "",
          searchResults: [],
          debounceTimer: null,
        },

        methods: {
          toggleDarkMode() {
            this.isDarkMode = !this.isDarkMode;
            document.body.classList.toggle("dark-mode");
          },

          toggleAdminMode() {
            this.isAdminMode = !this.isAdminMode;
            this.editingProductId = null;
          },

          async toggleCheckOutPage() {
            if (this.isProductPage) {
              // Leaving product page
              this.isProductPage = false;
              this.activeOrder = null;
              this.activeSortIndex = null;
              this.searchQuery = "";
            } else {
              // Coming back to product page
              this.isProductPage = true;
              this.currentPageNumber = 1;
            }
          },

          async searchLessons() {
            clearTimeout(this.debounceTimer);

            this.debounceTimer = setTimeout(async () => {
              const query = this.searchQuery.trim();

              // If empty → fetch all products
              if (!query) {
                try {
                  await this.fetchProducts();
                  this.currentPageNumber = 1;
                  this.showToast("Showing all lessons.");
                } catch (error) {
                  console.error(error);
                  this.products = [];
                }
                return;
              }

              // Otherwise → search API
              try {
                const url =
                  "/api/products/search?" +
                  new URLSearchParams({ q: query }).toString();

                const response = await fetch(url);
                if (!response.ok)
                  throw new Error(`Search failed: ${response.status}`);

                const results = await response.json();

                if (results.length === 0) {
                  this.showToast("No matching lessons found.");
                } else {
                  this.showToast(`${results.length} lessons found.`);
                }

                this.products = results;
                this.currentPageNumber = 1;
              } catch (error) {
                console.error(error.message);
                this.showToast("Error fetching search results.");
              }
            }, 300); // debounce delay
          },

          showToast(message) {
            this.toastMessage = message;
            this.toastVisible = true;

            // Hide after 3 seconds
            setTimeout(() => {
              this.toastVisible = false;
            }, 3000);
          },

          setSort(index) {
            // Toggle: uncheck if already active
            if (this.activeSortIndex === index) {
              this.activeSortIndex = null;
            } else {
              this.activeSortIndex = index;
            }
          },

          setOrder(order) {
            if (this.activeOrder === order) {
              this.activeOrder = null;
            } else {
              this.activeOrder = order;
            }
            this.currentPageNumber = 1;
          },

          startEditing(product) {
            if (this.editingProductId === product._id) {
              this.editingProductId = null;
              return;
            }

            this.editingProductId = product._id;

            // Copy product data
            this.editableProduct = {
              subject: product.subject,
              location: product.location,
              price: product.price,
              spaces: product.spaces,
            };
          },

          async saveEdit(productId) {
            const url = "/api/products/update";
            const updateBody = {
              id: productId,
              ...this.editableProduct,
            };

            try {
              const response = await fetch(url, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updateBody),
              });

              if (!response.ok) {
                throw new Error(`Response status: ${response.status}`);
              }

              await this.fetchProducts();
              this.editingProductId = null;
            } catch (error) {
              console.error(error.message);
            }
          },

          checkNumberOfProducts: function () {
            const numOfProducts = this.products.length;

            let numOfPages = Math.floor(numOfProducts / 6);
            const remainder = numOfProducts % 6;
            if (remainder != 0) {
              numOfPages++;
            }
            this.pageNumbers = numOfPages;
            this.populateNumOfPages(numOfPages);
          },

          populateNumOfPages(numOfPages) {
            let i = 1;
            while (numOfPages > 0) {
              this.pages.push(i);
              i++;
              numOfPages--;
            }
          },

          async fetchProducts() {
            const url = "/api/products";
            try {
              const response = await fetch(url);
              if (!response.ok)
                throw new Error(`Response status: ${response.status}`);
              this.products = await response.json();

              if (!Array.isArray(this.products)) this.products = [];
            } catch (error) {
              console.error(error.message);
              this.products = [];
            }
          },

          removeFromCart(objectId) {
            let targetPosition = this.orders.findIndex(
              (order) => order._id === objectId
            );

            if (targetPosition != -1) {
              this.orders.splice(targetPosition, 1);
            }

            targetPosition = this.products.findIndex(
              (product) => product._id === objectId
            );

            if (targetPosition != -1) {
              this.products[targetPosition].spaces++;
            }
            this.showToast("Product removed from cart !");
          },

          async addToCart(product) {
            // Populate orders array

            this.orders.push(product);
            product.spaces--;
            this.showToast("Product added to cart !");
          },

          async checkout() {
            // Validate fields before sending request

            const isEmpty = (obj) =>
              Object.values(obj).some((value) => !value || value.trim() === "");

            if (isEmpty(this.personal) || isEmpty(this.delivery)) {
              this.showToast("Please fill in all required fields.");
              return;
            }

            // Email regex validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(this.personal.email)) {
              this.showToast("Please enter a valid email address.");
              return;
            }

            // Phone = digits only
            const phoneRegex = /^[0-9]+$/;
            if (!phoneRegex.test(this.personal.phone)) {
              this.showToast("Phone number must contain only digits.");
              return;
            }

            // Postal code = digits only
            const postalRegex = /^[0-9]+$/;
            if (!postalRegex.test(this.delivery.postalCode)) {
              this.showToast("Postal code must contain only digits.");
              return;
            }

            // data to be sent
            const url = "/api/orders";
            const data = {
              personal: this.personal,
              delivery: this.delivery,
              orderIds: this.orders.map((o) => o._id),
            };

            try {
              const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
              });

              if (!response.ok)
                throw new Error(`Order creation failed: ${response.status}`);

              const result = await response.json();

              this.showToast("Order successfully submitted!");

              // Refresh products
              await this.fetchProducts();
              this.toggleCheckOutPage();

              // Clear cart and form
              this.orders = [];
              this.personal = {};
              this.delivery = {};
            } catch (error) {
              console.error(error.message);

              this.showToast("Order failed. Please try again.");
            }
          },
        },

        computed: {
          totalPages() {
            // always ensure products is an array
            const p = Array.isArray(this.products) ? this.products : [];
            return Math.ceil(p.length / 6) || 1;
          },

          pageList() {
            const total = this.totalPages || 1;
            return Array.from({ length: total }, (_, i) => i + 1);
          },

          sortedProducts() {
            // Ensure products is always an array
            const list = Array.isArray(this.products) ? this.products : [];

            let sorted = [...list];

            if (this.activeSortIndex !== null && this.activeOrder !== null) {
              const keyMap = ["subject", "location", "price", "spaces"];
              const key = keyMap[this.activeSortIndex];

              sorted.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (typeof valA === "string") {
                  valA = valA.toLowerCase();
                  valB = valB.toLowerCase();
                }

                if (valA < valB)
                  return this.activeOrder === "Ascending" ? -1 : 1;
                if (valA > valB)
                  return this.activeOrder === "Ascending" ? 1 : -1;
                return 0;
              });
            }

            return sorted;
          },

          loadCurrentProducts() {
            const list = Array.isArray(this.sortedProducts)
              ? this.sortedProducts
              : [];
            const start = (this.currentPageNumber - 1) * 6;
            const end = this.currentPageNumber * 6;
            return list.slice(start, end);
          },

          checkOrders() {
            return this.orders.length > 0 ? null : "disabled";
          },
        },

        async created() {
          await this.fetchProducts();
          this.checkNumberOfProducts();
        },
      });
    </script>
  </body>
</html>
